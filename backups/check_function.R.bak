#' Check a Function for Typical Errors
#'
#' Validates a single function argument for type and NULL.
#' Provides consistent error messages that include the argument name and
#' calling function name.
#'
#' @details
#' This function validates that the input is a callable function object.
#' Checks in sequence:
#' \enumerate{
#'   \item Validates logical parameters
#'   \item Checks if NULL when not allowed
#'   \item Returns NULL early if allowed
#'   \item Checks if input is a function type
#' }
#'
#' **What is a function?** In R, functions are first-class objects that can
#' be passed as arguments. This includes:
#' \itemize{
#'   \item Built-in functions (mean, sum, etc.)
#'   \item User-defined functions
#'   \item Anonymous functions
#'   \item Closures
#' }
#'
#' @param function_arg Function to check.
#' @param allow_null Logical. If TRUE, NULL is accepted. Default FALSE.
#'
#' @return Invisibly returns \code{function_arg} if all checks pass;
#'   otherwise throws an error.
#'
#' @return Invisibly returns \code{function_arg} if all checks pass; otherwise throws an error.
#' @examples
#' check_function(mean)
#' check_function(function(x) x + 1)
#' check_function(NULL, allow_null = TRUE)
#'
#' \dontrun{
#' check_function("not a function")  # Error
#' check_function(NULL)  # Error
#' }
#'
#' @export
check_function <- function(function_arg, allow_null = FALSE) {

  # ============================================================================
  # VALIDATE LOGICAL PARAMETERS
  # ============================================================================

  allow_null <- check_logical(allow_null)

  # ============================================================================
  # CHECK FOR NULL
  # ============================================================================

  if (is.null(function_arg) && isFALSE(allow_null)) {
    stop(
      sprintf(
        "Argument '%s' in function '%s' must be a non-NULL function.",
        as.character(substitute(function_arg)),
        deparse(sys.call(sys.parent())[[1]])
      ),
      call. = FALSE
    )
  }

  if (is.null(function_arg)) {
    return(invisible(NULL))
  }

  # ============================================================================
  # CHECK TYPE
  # ============================================================================

  if (!is.function(function_arg)) {
    stop(
      sprintf(
        "Argument '%s' in function '%s' must be a function.",
        as.character(substitute(function_arg)),
        deparse(sys.call(sys.parent())[[1]])
      ),
      call. = FALSE
    )
  }

  # ============================================================================
  # RETURN VALIDATED VALUE
  # ============================================================================

  invisible(function_arg)
}
